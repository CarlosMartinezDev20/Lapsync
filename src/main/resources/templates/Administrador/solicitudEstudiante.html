<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title th:text="'Préstamos de ' + ${user.fullName}">Préstamos del Usuario</title>

    <!-- Fuentes / Iconos (opcionales) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />

    <!-- Estilos globales -->
    <link rel="stylesheet" th:href="@{/css/app.css}" href="/css/app.css" />

    <!-- Tema antes de pintar (anti-FOUC) -->
    <script>
        !function(){
          try{
            var t=localStorage.getItem('theme')||(window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');
            document.documentElement.setAttribute('data-theme',t);
            document.documentElement.style.colorScheme=t;
          }catch(e){}
        }();
    </script>

    <!-- Estilos específicos de la vista (ligeros) -->
    <style>
        .table-card{ overflow:hidden }
        .table-toolbar{ padding:14px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; border-bottom:1px solid var(--border-soft) }

        /* Chips de estado del préstamo */
        .chip.state{ font-weight:800 }
        .chip.primary{ background:linear-gradient(180deg,#EEE8FF,#E7E0FF); color:var(--primary-600); border:1px solid rgba(124,58,237,.24) }

        /* Espacios */
        .w-tight { white-space:nowrap }
        .col-actions{ min-width:220px }
        @media (max-width:860px){ .col-actions{ min-width:180px } }

        /* Mini ayuda */
        .help-inline{ font-size:12px; color:var(--muted) }
    </style>
</head>

<body>
<!-- Header -->
<header class="app-header">
    <div class="brand">
        <i class="bi bi-laptop"></i>
        <div class="brand-text">
            <span class="title">LapSync</span>
            <span class="subtitle">Sistema de Préstamos</span>
        </div>
    </div>

    <div class="header-actions">
        <button id="themeToggle" class="btn btn-ghost theme-toggle" aria-label="Cambiar tema" title="Cambiar tema" aria-pressed="false">
            <i class="bi bi-sun-fill theme-icon sun"></i>
            <i class="bi bi-moon-stars-fill theme-icon moon"></i>
        </button>
        <a th:href="@{/administrador/dashboard}" class="btn btn-secondary"><i class="bi bi-house"></i> Dashboard</a>
    </div>
</header>

<main class="container app-main">
    <!-- Sub-barra -->
    <section class="panel-bar animate-in in centered-block">
        <div class="panel-left">
            <a th:href="@{/solicitudes}" class="btn btn-secondary btn-back"><i class="bi bi-arrow-left"></i> Volver</a>
            <div class="title">
                <i class="bi bi-person-badge"></i>
                <div>
                    <div style="font-weight:800" th:text="'Préstamos de ' + ${user.fullName}">Préstamos de Usuario</div>
                    <p class="meta" th:text="${#lists.size(prestamos)} + ' registro(s)'">0 registro(s)</p>
                </div>
            </div>
            <div>
            <a th:href="@{/detalleEstudiante/{id}(id=${user.id})}" class="btn btn-primary mb-3">
                <i class="bi bi-person-lines-fill"></i> Ver Detalles del Estudiante
            </a>
            </div>
        </div>
    </section>

    <!-- Tabla -->
    <section class="panel-card table-card animate-in in centered-block" style="--d:.05s">
        <div class="table-toolbar">
            <div class="help-inline">Gestiona estados y asignación de laptop</div>
        </div>

        <div class="table-wrap">
            <table class="data-table">
                <thead>
                <tr>
                    <th class="w-tight">Fecha y hora</th>
                    <th class="w-tight">Horas solicitadas</th>
                    <th>Estado</th>
                    <th>Laptop asignada</th>
                    <th class="col-actions">Acciones</th>
                    <th>Asignar laptop</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="loan : ${prestamos}"
                    th:with="
              status     = ${loan.status},
              isPending  = ${status == 'pending'},
              isApproved = ${status == 'approved'},
              isActive   = ${status == 'active'},
              isDone     = ${status == 'completed'},
              isRejected = ${status == 'rejected'},
              stateClass = ${
                isPending  ? 'warn'    :
                (isApproved? 'primary' :
                (isActive  ? 'warn'    :
                (isDone    ? 'success' : 'error')))
              }">
                    <!-- Fecha y hora -->
                    <td th:text="${loan.requestedAt != null ? #temporals.format(loan.requestedAt, 'dd/MM/yyyy HH:mm') : '—'}">—</td>

                    <!-- Horas -->
                    <td th:text="${loan.requestedHours}">0</td>

                    <!-- Estado -->
                    <td>
            <span class="chip state" th:classappend="${' ' + stateClass}"
                  th:text="${
                    isPending  ? 'Pendiente'   :
                    (isApproved? 'Aprobado'    :
                    (isActive  ? 'Activo'      :
                    (isDone    ? 'Completado'  : 'Rechazado')))
                  }">Estado</span>
                    </td>

                    <!-- Laptop asignada -->
                    <td th:text="${loan.laptop != null ? (loan.laptop.assetTag + ' · ' + loan.laptop.brand + ' ' + loan.laptop.model) : 'No asignada'}">
                        No asignada
                    </td>

                    <!-- Acciones -->
                    <td class="col-actions">
                        <!-- Botonera: sólo cuando no está finalizado ni rechazado -->
                        <form th:if="${!isDone and !isRejected}"
                              th:action="@{'/solicitudes-usuario/update/' + ${loan.id}}"
                              method="post"
                              style="display:flex; gap:8px; flex-wrap:wrap">

                            <button type="submit" name="action" value="approved"
                                    th:if="${isPending}"
                                    class="btn btn-primary">
                                <i class="bi bi-check2-square"></i> Aprobar
                            </button>

                            <button type="submit" name="action" value="rejected"
                                    th:if="${isPending}"
                                    class="btn btn-danger">
                                <i class="bi bi-x-octagon"></i> Rechazar
                            </button>

                            <button type="submit" name="action" value="active"
                                    th:if="${isApproved}"
                                    class="btn btn-secondary">
                                <i class="bi bi-play-fill"></i> Activar
                            </button>

                            <button type="submit" name="action" value="completed"
                                    th:if="${isActive}"
                                    class="btn btn-primary">
                                <i class="bi bi-check2-circle"></i> Completar
                            </button>
                        </form>

                        <!-- Mensajes finales (sin duplicar con columna Estado) -->
                        <span class="chip success" th:if="${isDone}">
              <i class="bi bi-check2-circle"></i> Préstamo completado
            </span>
                        <span class="chip error" th:if="${isRejected}">
              <i class="bi bi-x-octagon"></i> Préstamo rechazado
            </span>
                    </td>

                    <!-- Asignar laptop -->
                    <td>
                        <!-- Editable solo si está aprobado -->
                        <form th:if="${isApproved}"
                              th:action="@{'/solicitudes-usuario/update/' + ${loan.id}}"
                              method="post"
                              style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">

                            <select class="select" name="laptopId" style="min-width:260px">
                                <option value="" th:if="${loan.laptop == null}" selected>— Seleccionar laptop —</option>
                                <option th:each="lap : ${laptops}"
                                        th:value="${lap.id}"
                                        th:text="${lap.assetTag + ' · ' + lap.brand + ' ' + lap.model}"
                                        th:selected="${loan.laptop != null and loan.laptop.id == lap.id}">
                                </option>
                            </select>

                            <button type="submit" name="action" value="assign" class="btn btn-secondary">
                                <i class="bi bi-arrow-return-right"></i> Asignar
                            </button>
                        </form>

                        <!-- Solo lectura en otros estados -->
                        <span th:if="${!isApproved}"
                              th:text="${loan.laptop != null ? (loan.laptop.assetTag + ' · ' + loan.laptop.brand + ' ' + loan.laptop.model) : 'No asignada'}">
              No asignada
            </span>
                    </td>
                </tr>

                <tr th:if="${#lists.isEmpty(prestamos)}">
                    <td colspan="6" style="text-align:center; color:var(--muted); padding:32px 12px">
                        <i class="bi bi-inbox"></i><br/>No hay préstamos para este usuario
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>
</main>

<footer class="app-footer container">
    <span>© <span th:text="${#dates.format(#dates.createNow(),'yyyy')}">2025</span> LapSync</span>
    <span class="muted">Panel de administración</span>
</footer>

<!-- JS de tema (si ya lo tienes en /js/theme.js) -->
<script defer th:src="@{/js/theme.js}" src="/js/theme.js"></script>
</body>
</html>
