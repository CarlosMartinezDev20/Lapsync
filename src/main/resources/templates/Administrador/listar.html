<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Gestión de Administradores - LapSync</title>

    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"/>
    <link rel="stylesheet" th:href="@{/css/app.css}" href="/css/app.css"/>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        !function(){
          try{
            var t=localStorage.getItem('theme')||(window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');
            document.documentElement.setAttribute('data-theme',t);
            document.documentElement.style.colorScheme=t;
          }catch(e){}
        }();
    </script>

    <style>
        .btn, .btn:link, .btn:visited, .btn:hover, .btn:active, .btn:focus { text-decoration:none!important; outline:none; }
        .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap; padding:12px 12px 18px;}
        .toolbar .spacer{flex:1}
        .input-ghost{
          background:var(--panel); color:var(--text); border:1px solid var(--border-soft);
          border-radius:12px; padding:10px 12px; outline:none; min-width:240px; box-shadow:var(--shadow-1);
        }
        .input-ghost::placeholder{color:var(--muted)}
        .select-ghost{
          appearance:none;background:var(--panel); color:var(--text); border:1px solid var(--border-soft);
          border-radius:12px; padding:10px 12px; outline:none; box-shadow:var(--shadow-1);
        }
        .paginator{display:flex; align-items:center; gap:8px}
        .page-btn{
          border:1px solid var(--border-soft); background:var(--panel); color:var(--text);
          border-radius:10px; padding:8px 10px; cursor:pointer; box-shadow:var(--shadow-1)
        }
        .page-btn[disabled]{opacity:.5; cursor:not-allowed}
        .th-sortable{cursor:pointer; user-select:none}
        .th-sortable .arrow{opacity:.35; margin-left:6px}
        th.sorted-asc  .arrow{opacity:1; transform:rotate(180deg)}
        th.sorted-desc .arrow{opacity:1}
        .row-actions{display:flex; gap:8px; align-items:center; justify-content:center;} /* << centra botones */
        .panel-bar .panel-left{display:flex; align-items:center; gap:10px}
        .btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626); color:#fff}

        /* Centrado de la columna Acciones */
        th.col-actions, td.col-actions { text-align:center; }
        td.col-actions { vertical-align: middle; }
        td.col-actions > * { margin-inline:auto; } /* centra badges si no hay botones */
    </style>
</head>

<body>
<header class="app-header">
    <div class="brand">
        <i class="bi bi-laptop"></i>
        <div class="brand-text">
            <span class="title">LapSync</span>
            <span class="subtitle">Sistema de Préstamos</span>
        </div>
    </div>

    <div class="header-actions">
        <button id="themeToggle" class="btn btn-ghost theme-toggle" aria-label="Cambiar tema" title="Cambiar tema" aria-pressed="false">
            <i class="bi bi-sun-fill theme-icon sun"></i>
            <i class="bi bi-moon-stars-fill theme-icon moon"></i>
        </button>

        <a th:href="@{/administrador/dashboard}" class="btn btn-secondary"><i class="bi bi-house"></i> Dashboard</a>

        <form th:action="@{/logout}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button class="btn btn-ghost"><i class="bi bi-box-arrow-right"></i> Salir</button>
        </form>
    </div>
</header>

<main class="container app-main">
    <section class="panel-bar">
        <div class="panel-left">
            <a th:href="@{/administrador/dashboard}" class="btn btn-secondary btn-back">
                <i class="bi bi-arrow-left"></i> Volver
            </a>

            <div class="title">
                <i class="bi bi-shield-lock"></i>
                <div>
                    <div style="font-weight:800">Gestión de Administradores</div>
                    <p class="meta">Administra usuarios con roles <strong>ADMIN</strong> y <strong>SUPERADMIN</strong></p>
                </div>
            </div>
        </div>

        <a th:href="@{/administrador/crear}" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Nuevo administrador</a>
    </section>

    <section class="stats-grid">
        <article class="kpi-card animate-in in">
            <div class="kpi-head">
                <div class="kpi-icon soft-violet"><i class="bi bi-people-fill"></i></div>
                <div><h4 class="kpi-title">Total administradores</h4><p class="kpi-sub">Admin + Superadmin</p></div>
            </div>
            <div class="kpi-value" th:attr="data-target=${totalAdministradores}" th:text="${totalAdministradores}">0</div>
        </article>

        <article class="kpi-card animate-in in" style="--d:.05s">
            <div class="kpi-head">
                <div class="kpi-icon soft-blue"><i class="bi bi-shield-shaded"></i></div>
                <div><h4 class="kpi-title">Super administradores</h4><p class="kpi-sub">Privilegios completos</p></div>
            </div>
            <div class="kpi-value" th:attr="data-target=${#lists.size(superAdministradores)}" th:text="${#lists.size(superAdministradores)}">0</div>
        </article>

        <article class="kpi-card animate-in in" style="--d:.1s">
            <div class="kpi-head">
                <div class="kpi-icon soft-amber"><i class="bi bi-activity"></i></div>
                <div><h4 class="kpi-title">Administradores activos</h4><p class="kpi-sub">Admin + Superadmin</p></div>
            </div>
            <div class="kpi-value"
                 th:attr="data-target=${administradores.?[isActive].size() + superAdministradores.?[isActive].size()}"
                 th:text="${administradores.?[isActive].size() + superAdministradores.?[isActive].size()}">0</div>
        </article>
    </section>

    <section class="panel-card animate-in in">
        <div class="panel-head">
            <h3><i class="bi bi-table"></i> Lista general de usuarios con rol de admin</h3>
        </div>

        <div class="table-wrap">
            <div class="toolbar">
                <div class="spacer"></div>
                <label>
                    <input id="searchInput" class="input-ghost" type="search" placeholder="Buscar por nombre o correo…"/>
                </label>
                <label>
                    <select id="pageSize" class="select-ghost">
                        <option value="10">10 por página</option>
                        <option value="25">25 por página</option>
                        <option value="50">50 por página</option>
                        <option value="100">100 por página</option>
                    </select>
                </label>
            </div>

            <table id="adminsTable" class="data-table">
                <thead>
                <tr>
                    <th class="th-sortable" data-type="number">ID <i class="bi bi-caret-down-fill arrow"></i></th>
                    <th class="th-sortable" data-type="text">Nombre completo <i class="bi bi-caret-down-fill arrow"></i></th>
                    <th class="th-sortable" data-type="text">Email <i class="bi bi-caret-down-fill arrow"></i></th>
                    <th class="th-sortable" data-type="text">Rol <i class="bi bi-caret-down-fill arrow"></i></th>
                    <th class="th-sortable" data-type="date">Registro <i class="bi bi-caret-down-fill arrow"></i></th>
                    <th>Estado</th>
                    <th class="col-actions">Acciones</th> <!-- << centrado -->
                </tr>
                </thead>
                <tbody>
                <!-- SUPERADMINS -->
                <tr th:each="admin : ${superAdministradores}">
                    <td th:text="${admin.id}">1</td>
                    <td><strong th:text="${admin.fullName}">Super Admin</strong></td>
                    <td th:text="${admin.email}">super@ejemplo.com</td>
                    <td><span class="badge success">SUPERADMIN</span></td>
                    <td th:text="${admin.createdAt != null ? #temporals.format(admin.createdAt, 'dd/MM/yyyy') : 'N/A'}">01/01/2024</td>
                    <td>
                        <span th:if="${admin.isActive}" class="chip success"><i class="bi bi-check-circle"></i> Activo</span>
                        <span th:unless="${admin.isActive}" class="chip error"><i class="bi bi-x-circle"></i> Inactivo</span>
                    </td>
                    <td class="col-actions">
                        <div class="row-actions" th:if="${canEditSuper}">
                            <a th:href="@{/administrador/editar/{id}(id=${admin.id})}" class="btn btn-secondary" title="Editar">
                                <i class="bi bi-pencil-square"></i> Editar
                            </a>
                        </div>
                        <span class="badge primary" th:unless="${canEditSuper}">
                            <i class="bi bi-shield-lock"></i> Protegido
                        </span>
                    </td>
                </tr>

                <!-- ADMINS -->
                <tr th:each="admin : ${administradores}">
                    <td th:text="${admin.id}">2</td>
                    <td><strong th:text="${admin.fullName}">Admin</strong></td>
                    <td th:text="${admin.email}">admin@ejemplo.com</td>
                    <td><span class="badge primary">ADMIN</span></td>
                    <td th:text="${admin.createdAt != null ? #temporals.format(admin.createdAt, 'dd/MM/yyyy') : 'N/A'}">01/01/2024</td>
                    <td>
                        <span th:if="${admin.isActive}" class="chip success"><i class="bi bi-check-circle"></i> Activo</span>
                        <span th:unless="${admin.isActive}" class="chip error"><i class="bi bi-x-circle"></i> Inactivo</span>
                    </td>
                    <td class="col-actions">
                        <div class="row-actions">
                            <a th:href="@{/administrador/editar/{id}(id=${admin.id})}" class="btn btn-secondary" title="Editar">
                                <i class="bi bi-pencil-square"></i> Editar
                            </a>

                            <form th:id="'delete-form-' + ${admin.id}"
                                  th:action="@{/administrador/eliminar/{id}(id=${admin.id})}"
                                  method="post" style="display:none">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            </form>

                            <button type="button" class="btn btn-danger"
                                    th:attr="data-id=${admin.id}, data-name=${admin.fullName}"
                                    onclick="confirmarEliminar(this)" title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>

            <div class="toolbar" style="padding-top:8px;">
                <div id="pageInfo" class="muted">Mostrando 0–0 de 0</div>
                <div class="spacer"></div>
                <div class="paginator">
                    <button id="prevBtn" class="page-btn"><i class="bi bi-chevron-left"></i></button>
                    <button id="nextBtn" class="page-btn"><i class="bi bi-chevron-right"></i></button>
                </div>
            </div>
        </div>
    </section>
</main>

<footer class="app-footer container">
    <span>© <span th:text="${#dates.format(#dates.createNow(),'yyyy')}">2025</span> LapSync</span>
    <span class="muted">Panel de administración</span>
</footer>

<script defer th:src="@{/js/theme.js}" src="/js/theme.js"></script>

<script>
    function confirmarEliminar(btn){
      const id = btn.dataset.id;
      const nombre = btn.dataset.name;

      Swal.fire({
        title: '¿Eliminar administrador?',
        text: `Esta acción eliminará permanentemente a "${nombre}".`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
      }).then((res)=>{
        if(res.isConfirmed){
          const form = document.getElementById('delete-form-' + id);
          if(form) form.submit();
        }
      });
    }
</script>
</body>
</html>
