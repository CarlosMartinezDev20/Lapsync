<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Historial de laptop</title>

    <!-- Fuente & iconos -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />

    <!-- Estilos globales -->
    <link rel="stylesheet" th:href="@{/css/app.css}" href="/css/app.css" />

    <!-- Fijar tema antes de pintar -->
    <script>
        !function(){
          try{
            const t = localStorage.getItem('theme')
              || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light');
            document.documentElement.setAttribute('data-theme', t);
            document.documentElement.style.colorScheme = t;
          }catch(e){}
        }();
    </script>

    <!-- Ajustes leves de esta vista -->
    <style>
        .info-grid{display:grid; gap:10px; grid-template-columns: repeat(3, minmax(140px,1fr))}
        @media (max-width:720px){ .info-grid{ grid-template-columns:1fr } }
    </style>
</head>
<body>

<main class="container app-main">

    <!-- Barra superior -->
    <section class="panel-bar centered-block">
        <div class="panel-left">
            <a th:href="@{/laptops}" class="btn btn-secondary btn-back">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
            <div class="title">
                <i class="bi bi-clock-history"></i>
                <div>
                    <div style="font-weight:800">Historial de laptop</div>
                    <p class="meta">
                        <span th:text="'Asset: ' + ${laptop.assetTag}">Asset: LP-000</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="header-actions" style="display:flex; gap:10px; align-items:center">
            <button type="button" id="themeToggle" class="btn btn-ghost theme-toggle" title="Cambiar tema" style="padding:8px 12px">
                <i class="bi bi-brightness-high sun"></i>
                <i class="bi bi-moon moon"></i>
            </button>
        </div>
    </section>

    <!-- Tarjeta: resumen de la laptop -->
    <section class="panel-card centered-block animate-in in" style="--d:.05s">
        <div class="panel-head">
            <h3><i class="bi bi-laptop"></i> Resumen</h3>
        </div>
        <div style="padding:16px 18px">
            <div class="info-grid">
                <div>
                    <div class="muted">Asset Tag</div>
                    <strong th:text="${laptop.assetTag}">LP-000</strong>
                </div>
                <div>
                    <div class="muted">Marca</div>
                    <strong th:text="${laptop.brand}">Dell</strong>
                </div>
                <div>
                    <div class="muted">Modelo</div>
                    <strong th:text="${laptop.model}">Latitude 5400</strong>
                </div>
            </div>
        </div>
    </section>

    <!-- Préstamos -->
    <section class="panel-card centered-block animate-in in" style="--d:.08s">
        <div class="panel-head" style="display:flex; align-items:center; justify-content:space-between">
            <h3><i class="bi bi-box-seam"></i> Préstamos</h3>
            <span class="meta" th:text="${#lists.size(loans)} + ' registro(s)'">0 registro(s)</span>
        </div>

        <div class="table-wrap">
            <table class="data-table">
                <thead>
                <tr>
                    <th>Usuario</th>
                    <th>Correo</th>
                    <th>Código</th>
                    <th>Estado</th>
                    <th>Solicitado</th>
                    <th>Entregado</th>
                    <th>Devuelto</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="loan : ${loans}"
                    th:with="
              statusLower=${#strings.toLowerCase(loan.status)},
              statusCls=${(statusLower=='completed') ? 'success'
                        : (statusLower=='active')     ? 'primary'
                        : (statusLower=='approved')   ? 'primary'
                        : (statusLower=='pending')    ? 'warn'
                        : (statusLower=='rejected')   ? 'danger' : 'primary'},
              statusLabel=${(statusLower=='completed') ? 'Completado'
                          : (statusLower=='active')     ? 'Activo'
                          : (statusLower=='approved')   ? 'Aprobado'
                          : (statusLower=='pending')    ? 'Pendiente'
                          : (statusLower=='rejected')   ? 'Rechazado' : loan.status},
              req=${loan.requestedAt != null ? #temporals.format(loan.requestedAt, 'dd/MM/yyyy HH:mm') : '—'},
              del=${loan.deliveredAt != null ? #temporals.format(loan.deliveredAt, 'dd/MM/yyyy HH:mm') : '—'},
              ret=${loan.returnedAt  != null ? #temporals.format(loan.returnedAt , 'dd/MM/yyyy HH:mm') : '—'}
            ">
                    <td th:text="${loan.userFullName}">Nombre Apellido</td>
                    <td th:text="${loan.userEmail}">correo@ejemplo.com</td>
                    <td th:text="${loan.userStudentId}">000000</td>
                    <td>
                        <span class="badge" th:classappend="' ' + ${statusCls}" th:text="${statusLabel}">Pendiente</span>
                    </td>
                    <td th:text="${req}">—</td>
                    <td th:text="${del}">—</td>
                    <td th:text="${ret}">—</td>
                </tr>

                <tr th:if="${#lists.isEmpty(loans)}">
                    <td colspan="7" style="text-align:center; color:var(--muted); padding:24px 12px">
                        <i class="bi bi-inbox"></i> Sin préstamos registrados
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- Reportes de daño -->
    <section class="panel-card centered-block animate-in in" style="--d:.11s">
        <div class="panel-head" style="display:flex; align-items:center; justify-content:space-between">
            <h3><i class="bi bi-exclamation-triangle"></i> Reportes de daño</h3>
            <span class="meta" th:text="${#lists.size(damages)} + ' registro(s)'">0 registro(s)</span>
        </div>

        <div class="table-wrap">
            <table class="data-table">
                <thead>
                <tr>
                    <th>Descripción</th>
                    <th>Fecha</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="damage : ${damages}"
                    th:with="when=${damage.createdAt != null ? #temporals.format(damage.createdAt, 'dd/MM/yyyy HH:mm') : '—'}">
                    <td th:text="${damage.description}">Pantalla con rayones</td>
                    <td th:text="${when}">—</td>
                </tr>

                <tr th:if="${#lists.isEmpty(damages)}">
                    <td colspan="2" style="text-align:center; color:var(--muted); padding:24px 12px">
                        <i class="bi bi-inbox"></i> Sin reportes
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div style="padding:14px 18px; display:flex; justify-content:flex-end">
            <a th:href="@{/laptops}" class="btn btn-ghost">
                <i class="bi bi-arrow-left"></i> Volver a lista
            </a>
        </div>
    </section>

</main>

<footer class="app-footer container">
    <span>© <span th:text="${#dates.format(#dates.createNow(),'yyyy')}">2025</span> LapSync</span>
    <span class="muted">Panel de administración</span>
</footer>

<!-- Script toggle tema -->
<script>
    (function(){
      const btn = document.getElementById('themeToggle');
      if(!btn) return;
      btn.addEventListener('click', function(){
        const root = document.documentElement;
        const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        root.setAttribute('data-theme', next);
        root.style.colorScheme = next;
        try{ localStorage.setItem('theme', next); }catch(e){}
      });
    })();
</script>

</body>
</html>
